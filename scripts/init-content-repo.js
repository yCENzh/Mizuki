#!/usr/bin/env node

/**
 * Mizuki ÂÜÖÂÆπ‰ªìÂ∫ìÂàùÂßãÂåñËÑöÊú¨
 * Â∏ÆÂä©Áî®Êà∑Âø´ÈÄüËÆæÁΩÆ‰ª£Á†ÅÂÜÖÂÆπÂàÜÁ¶ª
 */

import { execSync } from 'child_process';
import fs from 'fs';
import path from 'path';
import readline from 'readline';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.resolve(__dirname, '..');

// Âä†ËΩΩ .env Êñá‰ª∂ÁöÑËæÖÂä©ÂáΩÊï∞
function loadEnvFile(envPath) {
  if (!fs.existsSync(envPath)) return;
  
  const envContent = fs.readFileSync(envPath, 'utf-8');
  envContent.split('\n').forEach(line => {
    line = line.trim();
    if (!line || line.startsWith('#')) return;
    
    const match = line.match(/^([^=]+)=(.*)$/);
    if (match) {
      const key = match[1].trim();
      let value = match[2].trim();
      value = value.replace(/^["']|["']$/g, '');
      process.env[key] = value;
    }
  });
}

// Âä†ËΩΩÁé∞ÊúâÁöÑ .env Êñá‰ª∂
loadEnvFile(path.join(rootDir, '.env'));

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function question(query) {
  return new Promise(resolve => rl.question(query, resolve));
}

function exec(command, options = {}) {
  try {
    return execSync(command, { stdio: 'inherit', ...options });
  } catch (error) {
    console.error(`‚ùå Command execution failed: ${command}`);
    throw error;
  }
}

async function main() {
  console.log('üå∏ Welcome to Mizuki Content Repository Initialization Wizard!\n');
  
  console.log('Using independent repository mode to manage content\n');
  
  // ËØ¢ÈóÆÂÜÖÂÆπ‰ªìÂ∫ì URL
  const repoUrl = await question('Please enter content repository URL (e.g., https://github.com/username/Mizuki-Content.git): ');
  
  if (!repoUrl.trim()) {
    console.error('‚ùå Content repository URL cannot be empty!');
    rl.close();
    return;
  }
  
  // Á°ÆËÆ§‰ø°ÊÅØ
  console.log('\nüìã Configuration:');
  console.log(`   Mode: Independent Repository`);
  console.log(`   Repository: ${repoUrl.trim()}`);
  
  const confirm = await question('\nConfirm to start initialization? (y/n): ');
  
  if (confirm.toLowerCase() !== 'y') {
    console.log('‚ùå Initialization cancelled');
    rl.close();
    return;
  }
  
  console.log('\nüöÄ Starting initialization...\n');
  
  // ÂàõÂª∫ .env Êñá‰ª∂
  const envPath = path.join(rootDir, '.env');
  const envContent = `# Mizuki Content Repository Configuration
# Auto-generated by initialization script

CONTENT_REPO_URL=${repoUrl.trim()}
CONTENT_DIR=./content

# Umami configuration (optional)
# UMAMI_API_KEY=your_api_key_here

# bcrypt configuration
BCRYPT_SALT_ROUNDS=12
`;
  
  fs.writeFileSync(envPath, envContent);
  console.log('‚úÖ Created .env file');
  
  // ÂêåÊ≠•ÂÜÖÂÆπ
  console.log('\nüì• Synchronizing content repository...');
  try {
    exec('pnpm run sync-content', { 
      cwd: rootDir,
      env: {
        ...process.env,
        CONTENT_REPO_URL: repoUrl.trim()
      }
    });
    console.log('‚úÖ Content synchronized successfully!');
  } catch (error) {
    console.error('‚ùå Content synchronization failed. Please check configuration and run manually: pnpm run sync-content');
  }
  
  // ÊèêÁ§∫ÂêéÁª≠Ê≠•È™§
  console.log('\nüéâ Initialization completed!\n');
  console.log('üìù Next steps:');
  console.log('1. Check content/ directory to confirm content has been synchronized');
  console.log('2. Run pnpm dev to start development server');
  console.log('3. Visit http://localhost:4321 to view your blog');
  console.log('\nüìö More information:');
  console.log('- Content repository structure: docs/CONTENT_REPOSITORY.md');
  console.log('- Migration guide: docs/MIGRATION_GUIDE.md');
  
  rl.close();
}

main().catch(error => {
  console.error('‚ùå Initialization failed:', error);
  rl.close();
  process.exit(1);
});
